name: Oracle SQL Import with Slot Structure

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  oracle-import:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Oracle Slot Directories
        run: |
          mkdir -p ~/oracle-slots/slot1
          mkdir -p ~/oracle-slots/slot2
          cp ./db/sql/*.sql ~/oracle-slots/slot1/
          echo "✅ 슬롯 디렉토리 생성 및 SQL 배치 완료"

      - name: Install Oracle Client (Instant Client)
        run: |
          sudo apt-get update
          sudo apt-get install -y libaio1 wget unzip
          wget https://download.oracle.com/otn_software/linux/instantclient/instantclient-basiclite-linux.x64-21.6.0.0.0dbru.zip
          unzip instantclient-basiclite-linux.x64-*.zip -d ~/oracle-client
          echo "LD_LIBRARY_PATH=$HOME/oracle-client/instantclient_21_6" >> $GITHUB_ENV
          echo "✅ Oracle Instant Client 설치 완료"

      - name: Import SQL files to Oracle DB
        env:
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
          ORACLE_PASS: ${{ secrets.ORACLE_PASS }}
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_SID:  ${{ secrets.ORACLE_SID }}
        run: |
          export PATH=$HOME/oracle-client/instantclient_21_6:$PATH
          export LD_LIBRARY_PATH=$HOME/oracle-client/instantclient_21_6
          echo "Connecting to Oracle: $ORACLE_USER@$ORACLE_HOST/$ORACLE_SID"
          for sqlfile in ~/oracle-slots/slot1/*.sql; do
            echo "▶ 실행: $sqlfile"
            echo exit | ./sqlplus64 "$ORACLE_USER/$ORACLE_PASS@(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=$ORACLE_HOST)(PORT=1521))(CONNECT_DATA=(SID=$ORACLE_SID)))" @"$sqlfile"
          done

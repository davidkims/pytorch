name: EthicalCheck-Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  Trigger_EthicalCheck:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        run: |
          mkdir -p ./ethicalcheck/output
          chmod -R 755 ./ethicalcheck

      - name: EthicalCheck - Free API Security Testing
        uses: apisec-inc/ethicalcheck-action@005fac321dd843682b1af6b72f30caaf9952c641
        with:
          oas-url: "https://petstore.swagger.io/v2/swagger.json"  # ✅ 실제 API 명세 URL로 교체
          email: "kwonny1302@gmail.com"
          sarif-result-file: "./ethicalcheck/output/ethicalcheck-results.sarif"

      - name: Check SARIF Output
        run: |
          if [ ! -s "./ethicalcheck/output/ethicalcheck-results.sarif" ]; then
            echo "❌ SARIF 파일이 비어있습니다. 업로드 생략"
            exit 1
          else
            echo "✅ SARIF 파일 정상 생성됨"
          fi

      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ./ethicalcheck/output/ethicalcheck-results.sarif
